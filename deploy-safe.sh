#!/bin/bash
# ============================================================
#  Agile Radio ‚Äî Safe Deploy Script (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞—Ä—Ç–∏—Å—Ç–æ–≤)
#  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-safe.sh "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
#
#  –û—Ç–ª–∏—á–∏–µ –æ—Ç deploy.sh:
#  ‚Ä¢ –ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–µ–ª–∞–µ—Ç –ë–≠–ö–ê–ü data/artists.json –∏ uploads/
#  ‚Ä¢ –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢ –∏—Ö
#  ‚Üí –ê—Ä—Ç–∏—Å—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É –ù–ï –ø—Ä–æ–ø–∞–¥—É—Ç
# ============================================================

VPS_IP="193.233.19.203"
VPS_USER="root"
VPS_PASS="tYbrC2G70GY7"
VPS_DIR="/var/www/agileradio"
COMMIT_MSG="${1:-update}"

set -e

echo "üöÄ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π (–∞—Ä—Ç–∏—Å—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è)..."

# ‚îÄ‚îÄ 1. –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo ""
echo "üì¶ –®–∞–≥ 1: –ö–æ–º–º–∏—Ç –∏ push –Ω–∞ GitHub..."
git add -A
if git diff --cached --quiet; then
  echo "   ‚ÑπÔ∏è  –ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
else
  git commit -m "$COMMIT_MSG"
  echo "   ‚úÖ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ: $COMMIT_MSG"
fi
git push origin main
echo "   ‚úÖ Push –Ω–∞ GitHub –≤—ã–ø–æ–ª–Ω–µ–Ω"

# ‚îÄ‚îÄ 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –ë–ï–ó –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo ""
echo "üñ•Ô∏è  –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ VPS (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞—Ä—Ç–∏—Å—Ç–æ–≤)..."
sshpass -p "$VPS_PASS" ssh -o StrictHostKeyChecking=no "$VPS_USER@$VPS_IP" << 'ENDSSH'
  set -e
  cd /var/www/agileradio

  # –ë—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è
  echo "   üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–∏—Å—Ç–æ–≤ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
  cp -f data/artists.json /tmp/artists_backup.json 2>/dev/null && echo "   ‚úÖ artists.json ‚Üí /tmp/artists_backup.json" || echo "   ‚ö†Ô∏è  artists.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
  cp -rf public/uploads/ /tmp/uploads_backup/ 2>/dev/null && echo "   ‚úÖ uploads/ ‚Üí /tmp/uploads_backup/" || echo "   ‚ö†Ô∏è  uploads/ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"

  # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
  echo "   ‚Üí git pull..."
  git pull origin main

  echo "   ‚Üí npm install..."
  npm ci --legacy-peer-deps --silent

  echo "   ‚Üí next build..."
  npm run build

  # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  echo "   üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ä—Ç–∏—Å—Ç–æ–≤ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
  cp -f /tmp/artists_backup.json data/artists.json 2>/dev/null && echo "   ‚úÖ artists.json –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "   ‚ö†Ô∏è  –ù–µ—á–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å"
  cp -rf /tmp/uploads_backup/. public/uploads/ 2>/dev/null && echo "   ‚úÖ uploads/ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" || echo "   ‚ö†Ô∏è  –ù–µ—á–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å"

  # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
  echo "   ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
  pm2 restart agileradio
  pm2 list
ENDSSH

echo ""
echo "‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
echo "   –°–∞–π—Ç: https://agileradio.online"
echo "   –ê—Ä—Ç–∏—Å—Ç—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ"
